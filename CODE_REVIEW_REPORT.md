# Code Review Report — AI Blog Bot (Telegram)

**Проект:** AI Blog Bot (Telegram-бот для управления Hugo-блогом)  
**Дата:** 10 февраля 2026  
**Версия:** v4 (Telegram Bot)  
**Ревьюер:** Manus AI  
**Тесты:** 44/44 пройдены  

---

## Резюме

Проведено полное код-ревью проекта AI Blog Bot — Telegram-бота для управления Hugo-блогом с AI-функциями (LLM tool-calling, генерация статей, поиск и генерация изображений). Обнаружено **22 проблемы**, из которых **19 исправлены** (все критические и высокие). Оставшиеся 3 — низкоприоритетные косметические замечания.

| Категория | Найдено | Исправлено | Осталось |
|-----------|---------|------------|----------|
| Критические | 3 | 3 | 0 |
| Высокие | 5 | 5 | 0 |
| Средние | 8 | 8 | 0 |
| Низкие | 6 | 3 | 3 |
| **Итого** | **22** | **19** | **3** |

---

## Критические проблемы (все исправлены)

### CR2-01: Утечка токена бота через URL фото

**Было:** Токен бота встраивался в URL при обработке фото от пользователя (`https://api.telegram.org/file/bot<TOKEN>/...`), что могло привести к утечке при логировании или сохранении контекста.

**Исправлено:** Файл скачивается в буфер, загружается на S3 через `storagePut()`, и в контекст передаётся безопасный S3 URL без токена.

### CR2-02: Отсутствие rate limiting

**Было:** Любой пользователь мог отправлять неограниченное количество сообщений, каждое из которых вызывало LLM API, что могло привести к исчерпанию квот и высоким расходам.

**Исправлено:** Добавлен per-user rate limiter (10 сообщений/минуту) с автоматической очисткой счётчиков. При превышении лимита бот отвечает предупреждением с указанием времени ожидания.

### CR2-03: Утечка памяти через unbounded контексты

**Было:** `userContexts` Map рос бесконечно — по одной записи на каждого уникального Telegram-пользователя, без механизма очистки.

**Исправлено:** Добавлена TTL-очистка (1 час неактивности), ограничение на количество сообщений в контексте (20 последних), и периодическая сборка мусора каждые 10 минут.

---

## Высокие проблемы (все исправлены)

### CR2-04: `/dev/tcp` не работает в Alpine Linux

**Было:** `entrypoint.sh` использовал bash-специфичный `/dev/tcp` для проверки доступности MySQL, что не работает в Alpine Linux (ash shell).

**Исправлено:** Заменено на `nc` (netcat), установленный в Dockerfile. Добавлен fallback с таймаутом 60 секунд.

### CR2-05: Команды без access control

**Было:** `/help` и `/new` команды не проверяли `isUserAllowed()`, позволяя неавторизованным пользователям их вызывать.

**Исправлено:** Все 7 команд (`/start`, `/help`, `/articles`, `/new`, `/stats`, `/sync`, `/settings`) теперь проверяют доступ через `isUserAllowed()` перед выполнением.

### CR2-06: Утечка внутренних ошибок пользователю

**Было:** Сообщения об ошибках отправлялись пользователю как есть, включая стектрейсы, строки подключения к БД и внутренние пути.

**Исправлено:** Добавлена функция `sanitizeErrorForUser()`, которая фильтрует внутренние детали и возвращает безопасное, человекочитаемое сообщение.

### CR2-07: Устаревшие метки в Dockerfile

**Было:** Labels содержали "AI Admin Panel" вместо "AI Blog Bot".

**Исправлено:** Обновлены все метки, описания и maintainer-информация.

### CR2-08: Отсутствие drizzle-kit в production

**Было:** `drizzle-kit` — devDependency, не устанавливается в production-образе, но entrypoint пытался запустить миграции.

**Исправлено:** Dockerfile обновлён: миграции генерируются на этапе сборки (build stage), SQL-файлы копируются в production-образ.

---

## Средние проблемы (все исправлены)

| ID | Проблема | Решение |
|----|----------|---------|
| CR2-09 | Неиспользуемые DB-хелперы для web-чатов | Удалены из `db.ts` |
| CR2-10 | Мёртвые таблицы `conversations`/`chat_messages` | Удалены из `schema.ts` и `init.sql` |
| CR2-11 | Нет graceful shutdown для бота | Добавлены обработчики `SIGINT`/`SIGTERM` с `bot.stop()` |
| CR2-12 | `escapeMarkdownV2` определена, но не используется | Экспортирована как утилита для будущего использования |
| CR2-13 | Хрупкая проверка порта Ollama в setup.sh | Исправлена regex-проверка на корректное определение порта |
| CR2-14 | `window.__TG_BOT_USERNAME__` никогда не устанавливается | Заменено на `import.meta.env.VITE_TG_BOT_USERNAME` |
| CR2-15 | Кнопка ведёт на `t.me/your_bot` | Используется env-переменная `VITE_TG_BOT_USERNAME` |
| CR2-16 | Docker Compose `required: false` совместимость | Документировано требование Docker Compose v2.20+ |

---

## Удалённый мёртвый код

В ходе ревью удалён значительный объём мёртвого кода, оставшегося от предыдущих версий (web-чат панель):

| Файл | Описание |
|------|----------|
| `server/routers/chat.ts` | Web-чат роутер (заменён Telegram-ботом) |
| `server/routers/ai.ts` | AI роутер (логика перенесена в telegram-bot.ts) |
| `server/routers/hugo.ts` | Hugo роутер (логика перенесена в telegram-bot.ts) |
| `drizzle/schema.ts` | Таблицы `chatConversations` / `chatMessages` |
| `server/db.ts` | Хелперы `addChatMessage`, `getConversationMessages`, `createConversation` и др. |
| `docker/mysql/init.sql` | Таблицы `conversations` / `chat_messages` |

---

## Низкие проблемы (3 оставлены)

| ID | Проблема | Причина |
|----|----------|---------|
| CR2-19 | Нет валидации callback query data | Данные генерируются ботом, риск минимален |
| CR2-20 | Fallback `pnpm install` без предупреждения | Стандартная практика для Docker-сборок |
| CR2-21 | Возможные неиспользуемые импорты в App.tsx | TypeScript LSP не показывает ошибок, влияние на бандл минимально |

---

## Тестовое покрытие

Расширенный набор из **44 тестов** (vitest), все проходят. Время выполнения: 827ms.

| Группа тестов | Кол-во | Описание |
|---------------|--------|----------|
| tRPC Router — auth.me | 2 | Аутентифицированный и анонимный доступ |
| tRPC Router — auth.logout | 2 | Очистка cookie, публичный доступ |
| tRPC Router — structure | 2 | Наличие auth/system, отсутствие chat |
| Telegram Bot Module | 3 | Экспорты, запуск без токена, создание бота |
| escapeLikePattern | 5 | SQL LIKE injection prevention |
| sanitizeToolArgs | 8 | Input sanitization, type handling, edge cases |
| splitMessage | 7 | Message splitting, unicode, boundaries |
| isUserAllowed | 7 | Access control, env parsing, edge cases |
| Security (интеграционные) | 6 | Injection, overflow, nested objects, ACL |
| auth.logout (legacy) | 1 | Cookie clearing reference test |
| **Итого** | **44** | — |

---

## Архитектурная оценка

### Сильные стороны

Проект демонстрирует чистую архитектуру с хорошим разделением ответственности. Бот-модуль (`telegram-bot.ts`) полностью изолирован от web-сервера и может работать независимо. Tool-calling архитектура LLM позволяет легко добавлять новые инструменты без изменения основного цикла обработки. Rate limiting и access control реализованы на уровне бота, а не отдельных команд, что обеспечивает единообразную защиту. Graceful shutdown с корректной остановкой polling предотвращает потерю данных при перезапуске. TTL-очистка контекстов предотвращает утечки памяти в долгоживущих процессах.

### Рекомендации на будущее

Для production-использования рекомендуется реализовать webhook-режим вместо polling (снижает нагрузку и ускоряет отклик), добавить персистентное хранение истории чатов в БД (сейчас контекст хранится только в памяти и теряется при перезапуске), внедрить метрики (Prometheus/Grafana) для мониторинга LLM-вызовов и времени ответа, а также рассмотреть очередь задач (Bull/BullMQ) для длительных операций генерации статей и изображений.

---

## Заключение

Проект находится в хорошем состоянии для production-использования. Все критические и высокие проблемы безопасности исправлены (утечка токена, rate limiting, access control, error sanitization, memory leaks). Код очищен от мёртвых зависимостей предыдущих версий. Тестовое покрытие адекватное для текущего размера проекта с 44 тестами, покрывающими безопасность, валидацию ввода, контроль доступа и утилиты.
